"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RootDns = void 0;
const cdk = require("@aws-cdk/core");
const iam = require("@aws-cdk/aws-iam");
const route53 = require("@aws-cdk/aws-route53");
const aws_route53_1 = require("@aws-cdk/aws-route53");
const utils = require("./dns/delegation-record-handler/utils");
/**
 * A class creating the main hosted zone and a role assumable by stages account to be able to set sub domain delegation.
 */
class RootDns extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.rootHostedZone = this.createRootHostedZone(props);
        for (const accountIndex in props.stagesAccounts) {
            const account = props.stagesAccounts[accountIndex];
            const stageSubZone = this.createStageSubZone(account, props.rootHostedZoneDNSName);
            this.createDNSAutoUpdateRole(account, stageSubZone);
            if (stageSubZone.hostedZoneNameServers) {
                new route53.RecordSet(this, `${account.accountName}SubZoneDelegationNSRecord`, {
                    recordType: route53.RecordType.NS,
                    target: aws_route53_1.RecordTarget.fromValues(...stageSubZone.hostedZoneNameServers ? stageSubZone.hostedZoneNameServers : ''),
                    recordName: stageSubZone.zoneName,
                    zone: this.rootHostedZone,
                });
            }
        }
        if (props.thirdPartyProviderDNSUsed &&
            this.rootHostedZone.hostedZoneNameServers) {
            new cdk.CfnOutput(this, `NS records`, {
                value: cdk.Fn.join(",", this.rootHostedZone.hostedZoneNameServers),
            });
        }
        else {
            throw new Error("Creation of DNS domain is not yet supported");
            // TODO: implement call to https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Route53Domains.html#registerDomain-property
        }
    }
    createStageSubZone(account, rootHostedZoneDNSName) {
        const subDomainPrefix = utils.getSubdomainPrefix(account.accountName, account.accountStageName);
        return new route53.HostedZone(this, `${subDomainPrefix}StageSubZone`, {
            zoneName: `${subDomainPrefix}.${rootHostedZoneDNSName}`,
        });
    }
    createDNSAutoUpdateRole(account, stageSubZone) {
        const dnsAutoUpdateRole = new iam.Role(this, stageSubZone.zoneName, {
            assumedBy: new iam.AccountPrincipal(account.accountId),
            roleName: utils.getDNSUpdateRoleNameFromSubZoneName(stageSubZone.zoneName)
        });
        dnsAutoUpdateRole.addToPolicy(new iam.PolicyStatement({
            resources: [stageSubZone.hostedZoneArn],
            actions: [
                "route53:GetHostedZone",
                "route53:ChangeResourceRecordSets",
                "route53:TestDNSAnswer",
            ],
        }));
        dnsAutoUpdateRole.addToPolicy(new iam.PolicyStatement({
            resources: ['*'],
            actions: [
                "route53:ListHostedZonesByName"
            ],
        }));
        return dnsAutoUpdateRole;
    }
    createRootHostedZone(props) {
        return new route53.HostedZone(this, "RootHostedZone", {
            zoneName: props.rootHostedZoneDNSName,
        });
    }
}
exports.RootDns = RootDns;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG5zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFxQztBQUNyQyx3Q0FBd0M7QUFDeEMsZ0RBQWdEO0FBQ2hELHNEQUFvRDtBQUVwRCwrREFBK0Q7Ozs7QUF3Qi9ELE1BQWEsT0FBUSxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBR3hDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBbUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV2RCxLQUFLLE1BQU0sWUFBWSxJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUU7WUFDL0MsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQzFDLE9BQU8sRUFDUCxLQUFLLENBQUMscUJBQXFCLENBQzVCLENBQUM7WUFDRixJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ3BELElBQUksWUFBWSxDQUFDLHFCQUFxQixFQUFFO2dCQUN0QyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQ25CLElBQUksRUFDSixHQUFHLE9BQU8sQ0FBQyxXQUFXLDJCQUEyQixFQUNqRDtvQkFDRSxVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO29CQUNqQyxNQUFNLEVBQUUsMEJBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxZQUFZLENBQUMscUJBQXFCLENBQUEsQ0FBQyxDQUFBLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQSxDQUFDLENBQUEsRUFBRSxDQUFDO29CQUM1RyxVQUFVLEVBQUUsWUFBWSxDQUFDLFFBQVE7b0JBQ2pDLElBQUksRUFBRSxJQUFJLENBQUMsY0FBYztpQkFDMUIsQ0FDRixDQUFDO2FBQ0g7U0FDRjtRQUVELElBQ0UsS0FBSyxDQUFDLHlCQUF5QjtZQUMvQixJQUFJLENBQUMsY0FBYyxDQUFDLHFCQUFxQixFQUN6QztZQUNBLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO2dCQUNwQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUM7YUFDbkUsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQztZQUMvRCw4SEFBOEg7U0FDL0g7SUFDSCxDQUFDO0lBRUQsa0JBQWtCLENBQ2hCLE9BQWdCLEVBQ2hCLHFCQUE2QjtRQUU3QixNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNoRyxPQUFPLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxlQUFlLGNBQWMsRUFBRTtZQUNwRSxRQUFRLEVBQUUsR0FBRyxlQUFlLElBQUkscUJBQXFCLEVBQUU7U0FDeEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHVCQUF1QixDQUNyQixPQUFnQixFQUNoQixZQUFnQztRQUVoQyxNQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLFFBQVEsRUFBRTtZQUNsRSxTQUFTLEVBQUUsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUN0RCxRQUFRLEVBQUUsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7U0FDM0UsQ0FBQyxDQUFDO1FBRUgsaUJBQWlCLENBQUMsV0FBVyxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsU0FBUyxFQUFFLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQztZQUN2QyxPQUFPLEVBQUU7Z0JBQ1AsdUJBQXVCO2dCQUN2QixrQ0FBa0M7Z0JBQ2xDLHVCQUF1QjthQUN4QjtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBQ0YsaUJBQWlCLENBQUMsV0FBVyxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2hCLE9BQU8sRUFBRTtnQkFDUCwrQkFBK0I7YUFDaEM7U0FDRixDQUFDLENBQ0gsQ0FBQztRQUNGLE9BQU8saUJBQWlCLENBQUM7SUFDM0IsQ0FBQztJQUVELG9CQUFvQixDQUFDLEtBQW1CO1FBQ3RDLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNwRCxRQUFRLEVBQUUsS0FBSyxDQUFDLHFCQUFxQjtTQUN0QyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUF0RkQsMEJBc0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcIkBhd3MtY2RrL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgeyBSZWNvcmRUYXJnZXQgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCB7QWNjb3VudH0gZnJvbSAnLi9hY2NvdW50JztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4vZG5zL2RlbGVnYXRpb24tcmVjb3JkLWhhbmRsZXIvdXRpbHMnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgUm9vdERuc1Byb3BzIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgc3RhZ2VzQWNjb3VudHM6IEFjY291bnRbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSByb290SG9zdGVkWm9uZUROU05hbWU6IHN0cmluZztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgdGhpcmRQYXJ0eVByb3ZpZGVyRE5TVXNlZD86IGJvb2xlYW47XG59XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBjbGFzcyBSb290RG5zIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG4gIHJvb3RIb3N0ZWRab25lOiByb3V0ZTUzLklIb3N0ZWRab25lO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUm9vdERuc1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcbiAgICB0aGlzLnJvb3RIb3N0ZWRab25lID0gdGhpcy5jcmVhdGVSb290SG9zdGVkWm9uZShwcm9wcyk7XG5cbiAgICBmb3IgKGNvbnN0IGFjY291bnRJbmRleCBpbiBwcm9wcy5zdGFnZXNBY2NvdW50cykge1xuICAgICAgY29uc3QgYWNjb3VudCA9IHByb3BzLnN0YWdlc0FjY291bnRzW2FjY291bnRJbmRleF07XG4gICAgICBjb25zdCBzdGFnZVN1YlpvbmUgPSB0aGlzLmNyZWF0ZVN0YWdlU3ViWm9uZShcbiAgICAgICAgYWNjb3VudCxcbiAgICAgICAgcHJvcHMucm9vdEhvc3RlZFpvbmVETlNOYW1lXG4gICAgICApO1xuICAgICAgdGhpcy5jcmVhdGVETlNBdXRvVXBkYXRlUm9sZShhY2NvdW50LCBzdGFnZVN1YlpvbmUpO1xuICAgICAgaWYgKHN0YWdlU3ViWm9uZS5ob3N0ZWRab25lTmFtZVNlcnZlcnMpIHtcbiAgICAgICAgbmV3IHJvdXRlNTMuUmVjb3JkU2V0KFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgYCR7YWNjb3VudC5hY2NvdW50TmFtZX1TdWJab25lRGVsZWdhdGlvbk5TUmVjb3JkYCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZWNvcmRUeXBlOiByb3V0ZTUzLlJlY29yZFR5cGUuTlMsXG4gICAgICAgICAgICB0YXJnZXQ6IFJlY29yZFRhcmdldC5mcm9tVmFsdWVzKC4uLnN0YWdlU3ViWm9uZS5ob3N0ZWRab25lTmFtZVNlcnZlcnM/c3RhZ2VTdWJab25lLmhvc3RlZFpvbmVOYW1lU2VydmVyczonJyksXG4gICAgICAgICAgICByZWNvcmROYW1lOiBzdGFnZVN1YlpvbmUuem9uZU5hbWUsXG4gICAgICAgICAgICB6b25lOiB0aGlzLnJvb3RIb3N0ZWRab25lLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBwcm9wcy50aGlyZFBhcnR5UHJvdmlkZXJETlNVc2VkICYmXG4gICAgICB0aGlzLnJvb3RIb3N0ZWRab25lLmhvc3RlZFpvbmVOYW1lU2VydmVyc1xuICAgICkge1xuICAgICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgYE5TIHJlY29yZHNgLCB7XG4gICAgICAgIHZhbHVlOiBjZGsuRm4uam9pbihcIixcIiwgdGhpcy5yb290SG9zdGVkWm9uZS5ob3N0ZWRab25lTmFtZVNlcnZlcnMpLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNyZWF0aW9uIG9mIEROUyBkb21haW4gaXMgbm90IHlldCBzdXBwb3J0ZWRcIik7XG4gICAgICAvLyBUT0RPOiBpbXBsZW1lbnQgY2FsbCB0byBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQVdTSmF2YVNjcmlwdFNESy9sYXRlc3QvQVdTL1JvdXRlNTNEb21haW5zLmh0bWwjcmVnaXN0ZXJEb21haW4tcHJvcGVydHlcbiAgICB9XG4gIH1cblxuICBjcmVhdGVTdGFnZVN1YlpvbmUoXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICByb290SG9zdGVkWm9uZUROU05hbWU6IHN0cmluZ1xuICApOiByb3V0ZTUzLkhvc3RlZFpvbmUge1xuICAgIGNvbnN0IHN1YkRvbWFpblByZWZpeCA9IHV0aWxzLmdldFN1YmRvbWFpblByZWZpeChhY2NvdW50LmFjY291bnROYW1lLCBhY2NvdW50LmFjY291bnRTdGFnZU5hbWUpO1xuICAgIHJldHVybiBuZXcgcm91dGU1My5Ib3N0ZWRab25lKHRoaXMsIGAke3N1YkRvbWFpblByZWZpeH1TdGFnZVN1YlpvbmVgLCB7XG4gICAgICB6b25lTmFtZTogYCR7c3ViRG9tYWluUHJlZml4fS4ke3Jvb3RIb3N0ZWRab25lRE5TTmFtZX1gLFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlRE5TQXV0b1VwZGF0ZVJvbGUoXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICBzdGFnZVN1YlpvbmU6IHJvdXRlNTMuSG9zdGVkWm9uZVxuICApIHtcbiAgICBjb25zdCBkbnNBdXRvVXBkYXRlUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBzdGFnZVN1YlpvbmUuem9uZU5hbWUsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5BY2NvdW50UHJpbmNpcGFsKGFjY291bnQuYWNjb3VudElkKSxcbiAgICAgIHJvbGVOYW1lOiB1dGlscy5nZXRETlNVcGRhdGVSb2xlTmFtZUZyb21TdWJab25lTmFtZShzdGFnZVN1YlpvbmUuem9uZU5hbWUpXG4gICAgfSk7XG5cbiAgICBkbnNBdXRvVXBkYXRlUm9sZS5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgcmVzb3VyY2VzOiBbc3RhZ2VTdWJab25lLmhvc3RlZFpvbmVBcm5dLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgXCJyb3V0ZTUzOkdldEhvc3RlZFpvbmVcIixcbiAgICAgICAgICBcInJvdXRlNTM6Q2hhbmdlUmVzb3VyY2VSZWNvcmRTZXRzXCIsXG4gICAgICAgICAgXCJyb3V0ZTUzOlRlc3RETlNBbnN3ZXJcIixcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBkbnNBdXRvVXBkYXRlUm9sZS5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwicm91dGU1MzpMaXN0SG9zdGVkWm9uZXNCeU5hbWVcIlxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiBkbnNBdXRvVXBkYXRlUm9sZTtcbiAgfVxuXG4gIGNyZWF0ZVJvb3RIb3N0ZWRab25lKHByb3BzOiBSb290RG5zUHJvcHMpIHtcbiAgICByZXR1cm4gbmV3IHJvdXRlNTMuSG9zdGVkWm9uZSh0aGlzLCBcIlJvb3RIb3N0ZWRab25lXCIsIHtcbiAgICAgIHpvbmVOYW1lOiBwcm9wcy5yb290SG9zdGVkWm9uZUROU05hbWUsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==