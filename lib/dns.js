"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RootDns = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const cdk = require("@aws-cdk/core");
const iam = require("@aws-cdk/aws-iam");
const route53 = require("@aws-cdk/aws-route53");
const aws_route53_1 = require("@aws-cdk/aws-route53");
const utils = require("./dns/delegation-record-handler/utils");
/**
 * A class creating the main hosted zone and a role assumable by stages account to be able to set sub domain delegation.
 */
class RootDns extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.rootHostedZone = this.createRootHostedZone(props);
        for (const accountIndex in props.stagesAccounts) {
            const account = props.stagesAccounts[accountIndex];
            const stageSubZone = this.createStageSubZone(account, props.rootHostedZoneDNSName);
            this.createDNSAutoUpdateRole(account, stageSubZone);
            if (stageSubZone.hostedZoneNameServers) {
                new route53.RecordSet(this, `${account.accountName}SubZoneDelegationNSRecord`, {
                    recordType: route53.RecordType.NS,
                    target: aws_route53_1.RecordTarget.fromValues(...stageSubZone.hostedZoneNameServers ? stageSubZone.hostedZoneNameServers : ''),
                    recordName: stageSubZone.zoneName,
                    zone: this.rootHostedZone,
                });
            }
        }
        if (props.thirdPartyProviderDNSUsed &&
            this.rootHostedZone.hostedZoneNameServers) {
            new cdk.CfnOutput(this, `NS records`, {
                value: cdk.Fn.join(",", this.rootHostedZone.hostedZoneNameServers),
            });
        }
        else {
            throw new Error("Creation of DNS domain is not yet supported");
            // TODO: implement call to https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Route53Domains.html#registerDomain-property
        }
    }
    createStageSubZone(account, rootHostedZoneDNSName) {
        const subDomainPrefix = utils.getSubdomainPrefix(account.accountName, account.accountStageName);
        return new route53.HostedZone(this, `${subDomainPrefix}StageSubZone`, {
            zoneName: `${subDomainPrefix}.${rootHostedZoneDNSName}`,
        });
    }
    createDNSAutoUpdateRole(account, stageSubZone) {
        const dnsAutoUpdateRole = new iam.Role(this, stageSubZone.zoneName, {
            assumedBy: new iam.AccountPrincipal(account.accountId),
            roleName: utils.getDNSUpdateRoleNameFromSubZoneName(stageSubZone.zoneName)
        });
        dnsAutoUpdateRole.addToPolicy(new iam.PolicyStatement({
            resources: [stageSubZone.hostedZoneArn],
            actions: [
                "route53:GetHostedZone",
                "route53:ChangeResourceRecordSets",
                "route53:TestDNSAnswer",
            ],
        }));
        dnsAutoUpdateRole.addToPolicy(new iam.PolicyStatement({
            resources: ['*'],
            actions: [
                "route53:ListHostedZonesByName"
            ],
        }));
        return dnsAutoUpdateRole;
    }
    createRootHostedZone(props) {
        return new route53.HostedZone(this, "RootHostedZone", {
            zoneName: props.rootHostedZoneDNSName,
        });
    }
}
exports.RootDns = RootDns;
_a = JSII_RTTI_SYMBOL_1;
RootDns[_a] = { fqn: "aws-bootstrap-kit.RootDns", version: "0.3.9" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG5zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQXFDO0FBQ3JDLHdDQUF3QztBQUN4QyxnREFBZ0Q7QUFDaEQsc0RBQW9EO0FBRXBELCtEQUErRDs7OztBQXdCL0QsTUFBYSxPQUFRLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFHeEMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFtQjtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXZELEtBQUssTUFBTSxZQUFZLElBQUksS0FBSyxDQUFDLGNBQWMsRUFBRTtZQUMvQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ25ELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FDMUMsT0FBTyxFQUNQLEtBQUssQ0FBQyxxQkFBcUIsQ0FDNUIsQ0FBQztZQUNGLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDcEQsSUFBSSxZQUFZLENBQUMscUJBQXFCLEVBQUU7Z0JBQ3RDLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FDbkIsSUFBSSxFQUNKLEdBQUcsT0FBTyxDQUFDLFdBQVcsMkJBQTJCLEVBQ2pEO29CQUNFLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7b0JBQ2pDLE1BQU0sRUFBRSwwQkFBWSxDQUFDLFVBQVUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQSxDQUFDLENBQUEsWUFBWSxDQUFDLHFCQUFxQixDQUFBLENBQUMsQ0FBQSxFQUFFLENBQUM7b0JBQzVHLFVBQVUsRUFBRSxZQUFZLENBQUMsUUFBUTtvQkFDakMsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjO2lCQUMxQixDQUNGLENBQUM7YUFDSDtTQUNGO1FBRUQsSUFDRSxLQUFLLENBQUMseUJBQXlCO1lBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMscUJBQXFCLEVBQ3pDO1lBQ0EsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQ3BDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQzthQUNuRSxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1lBQy9ELDhIQUE4SDtTQUMvSDtJQUNILENBQUM7SUFFRCxrQkFBa0IsQ0FDaEIsT0FBZ0IsRUFDaEIscUJBQTZCO1FBRTdCLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2hHLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLGVBQWUsY0FBYyxFQUFFO1lBQ3BFLFFBQVEsRUFBRSxHQUFHLGVBQWUsSUFBSSxxQkFBcUIsRUFBRTtTQUN4RCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsdUJBQXVCLENBQ3JCLE9BQWdCLEVBQ2hCLFlBQWdDO1FBRWhDLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsUUFBUSxFQUFFO1lBQ2xFLFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO1lBQ3RELFFBQVEsRUFBRSxLQUFLLENBQUMsbUNBQW1DLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQztTQUMzRSxDQUFDLENBQUM7UUFFSCxpQkFBaUIsQ0FBQyxXQUFXLENBQzNCLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUN0QixTQUFTLEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDO1lBQ3ZDLE9BQU8sRUFBRTtnQkFDUCx1QkFBdUI7Z0JBQ3ZCLGtDQUFrQztnQkFDbEMsdUJBQXVCO2FBQ3hCO1NBQ0YsQ0FBQyxDQUNILENBQUM7UUFDRixpQkFBaUIsQ0FBQyxXQUFXLENBQzNCLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUN0QixTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDaEIsT0FBTyxFQUFFO2dCQUNQLCtCQUErQjthQUNoQztTQUNGLENBQUMsQ0FDSCxDQUFDO1FBQ0YsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBRUQsb0JBQW9CLENBQUMsS0FBbUI7UUFDdEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ3BELFFBQVEsRUFBRSxLQUFLLENBQUMscUJBQXFCO1NBQ3RDLENBQUMsQ0FBQztJQUNMLENBQUM7O0FBckZILDBCQXNGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJAYXdzLWNkay9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1M1wiO1xuaW1wb3J0IHsgUmVjb3JkVGFyZ2V0IH0gZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQge0FjY291bnR9IGZyb20gJy4vYWNjb3VudCc7XG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuL2Rucy9kZWxlZ2F0aW9uLXJlY29yZC1oYW5kbGVyL3V0aWxzJztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgaW50ZXJmYWNlIFJvb3REbnNQcm9wcyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHN0YWdlc0FjY291bnRzOiBBY2NvdW50W107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgcm9vdEhvc3RlZFpvbmVETlNOYW1lOiBzdHJpbmc7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHRoaXJkUGFydHlQcm92aWRlckROU1VzZWQ/OiBib29sZWFuO1xufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgY2xhc3MgUm9vdERucyBleHRlbmRzIGNkay5Db25zdHJ1Y3Qge1xuICByb290SG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFJvb3REbnNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgdGhpcy5yb290SG9zdGVkWm9uZSA9IHRoaXMuY3JlYXRlUm9vdEhvc3RlZFpvbmUocHJvcHMpO1xuXG4gICAgZm9yIChjb25zdCBhY2NvdW50SW5kZXggaW4gcHJvcHMuc3RhZ2VzQWNjb3VudHMpIHtcbiAgICAgIGNvbnN0IGFjY291bnQgPSBwcm9wcy5zdGFnZXNBY2NvdW50c1thY2NvdW50SW5kZXhdO1xuICAgICAgY29uc3Qgc3RhZ2VTdWJab25lID0gdGhpcy5jcmVhdGVTdGFnZVN1YlpvbmUoXG4gICAgICAgIGFjY291bnQsXG4gICAgICAgIHByb3BzLnJvb3RIb3N0ZWRab25lRE5TTmFtZVxuICAgICAgKTtcbiAgICAgIHRoaXMuY3JlYXRlRE5TQXV0b1VwZGF0ZVJvbGUoYWNjb3VudCwgc3RhZ2VTdWJab25lKTtcbiAgICAgIGlmIChzdGFnZVN1YlpvbmUuaG9zdGVkWm9uZU5hbWVTZXJ2ZXJzKSB7XG4gICAgICAgIG5ldyByb3V0ZTUzLlJlY29yZFNldChcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIGAke2FjY291bnQuYWNjb3VudE5hbWV9U3ViWm9uZURlbGVnYXRpb25OU1JlY29yZGAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVjb3JkVHlwZTogcm91dGU1My5SZWNvcmRUeXBlLk5TLFxuICAgICAgICAgICAgdGFyZ2V0OiBSZWNvcmRUYXJnZXQuZnJvbVZhbHVlcyguLi5zdGFnZVN1YlpvbmUuaG9zdGVkWm9uZU5hbWVTZXJ2ZXJzP3N0YWdlU3ViWm9uZS5ob3N0ZWRab25lTmFtZVNlcnZlcnM6JycpLFxuICAgICAgICAgICAgcmVjb3JkTmFtZTogc3RhZ2VTdWJab25lLnpvbmVOYW1lLFxuICAgICAgICAgICAgem9uZTogdGhpcy5yb290SG9zdGVkWm9uZSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgcHJvcHMudGhpcmRQYXJ0eVByb3ZpZGVyRE5TVXNlZCAmJlxuICAgICAgdGhpcy5yb290SG9zdGVkWm9uZS5ob3N0ZWRab25lTmFtZVNlcnZlcnNcbiAgICApIHtcbiAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIGBOUyByZWNvcmRzYCwge1xuICAgICAgICB2YWx1ZTogY2RrLkZuLmpvaW4oXCIsXCIsIHRoaXMucm9vdEhvc3RlZFpvbmUuaG9zdGVkWm9uZU5hbWVTZXJ2ZXJzKSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDcmVhdGlvbiBvZiBETlMgZG9tYWluIGlzIG5vdCB5ZXQgc3VwcG9ydGVkXCIpO1xuICAgICAgLy8gVE9ETzogaW1wbGVtZW50IGNhbGwgdG8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU0phdmFTY3JpcHRTREsvbGF0ZXN0L0FXUy9Sb3V0ZTUzRG9tYWlucy5odG1sI3JlZ2lzdGVyRG9tYWluLXByb3BlcnR5XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlU3RhZ2VTdWJab25lKFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgcm9vdEhvc3RlZFpvbmVETlNOYW1lOiBzdHJpbmdcbiAgKTogcm91dGU1My5Ib3N0ZWRab25lIHtcbiAgICBjb25zdCBzdWJEb21haW5QcmVmaXggPSB1dGlscy5nZXRTdWJkb21haW5QcmVmaXgoYWNjb3VudC5hY2NvdW50TmFtZSwgYWNjb3VudC5hY2NvdW50U3RhZ2VOYW1lKTtcbiAgICByZXR1cm4gbmV3IHJvdXRlNTMuSG9zdGVkWm9uZSh0aGlzLCBgJHtzdWJEb21haW5QcmVmaXh9U3RhZ2VTdWJab25lYCwge1xuICAgICAgem9uZU5hbWU6IGAke3N1YkRvbWFpblByZWZpeH0uJHtyb290SG9zdGVkWm9uZUROU05hbWV9YCxcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZUROU0F1dG9VcGRhdGVSb2xlKFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgc3RhZ2VTdWJab25lOiByb3V0ZTUzLkhvc3RlZFpvbmVcbiAgKSB7XG4gICAgY29uc3QgZG5zQXV0b1VwZGF0ZVJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgc3RhZ2VTdWJab25lLnpvbmVOYW1lLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uQWNjb3VudFByaW5jaXBhbChhY2NvdW50LmFjY291bnRJZCksXG4gICAgICByb2xlTmFtZTogdXRpbHMuZ2V0RE5TVXBkYXRlUm9sZU5hbWVGcm9tU3ViWm9uZU5hbWUoc3RhZ2VTdWJab25lLnpvbmVOYW1lKVxuICAgIH0pO1xuXG4gICAgZG5zQXV0b1VwZGF0ZVJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIHJlc291cmNlczogW3N0YWdlU3ViWm9uZS5ob3N0ZWRab25lQXJuXSxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwicm91dGU1MzpHZXRIb3N0ZWRab25lXCIsXG4gICAgICAgICAgXCJyb3V0ZTUzOkNoYW5nZVJlc291cmNlUmVjb3JkU2V0c1wiLFxuICAgICAgICAgIFwicm91dGU1MzpUZXN0RE5TQW5zd2VyXCIsXG4gICAgICAgIF0sXG4gICAgICB9KVxuICAgICk7XG4gICAgZG5zQXV0b1VwZGF0ZVJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcInJvdXRlNTM6TGlzdEhvc3RlZFpvbmVzQnlOYW1lXCJcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gZG5zQXV0b1VwZGF0ZVJvbGU7XG4gIH1cblxuICBjcmVhdGVSb290SG9zdGVkWm9uZShwcm9wczogUm9vdERuc1Byb3BzKSB7XG4gICAgcmV0dXJuIG5ldyByb3V0ZTUzLkhvc3RlZFpvbmUodGhpcywgXCJSb290SG9zdGVkWm9uZVwiLCB7XG4gICAgICB6b25lTmFtZTogcHJvcHMucm9vdEhvc3RlZFpvbmVETlNOYW1lLFxuICAgIH0pO1xuICB9XG59XG4iXX0=