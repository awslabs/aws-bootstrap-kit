"use strict";
/*
Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License").
You may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsOrganizationsStack = void 0;
const cdk = require("@aws-cdk/core");
const organization_1 = require("./organization");
const organizational_unit_1 = require("./organizational-unit");
const account_1 = require("./account");
const secure_root_user_1 = require("./secure-root-user");
const organization_trail_1 = require("./organization-trail");
const package_json_1 = require("../package.json");
const dns_1 = require("./dns");
const validate_email_1 = require("./validate-email");
/**
 * A Stack creating the Software Development Life Cycle (SDLC) Organization.
 */
class AwsOrganizationsStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, { description: `Software development Landing Zone (uksb-1r7an8o45) (version:${package_json_1.version})`, ...props });
        this.stageAccounts = [];
        const { email, nestedOU, forceEmailVerification = true } = props;
        if (nestedOU.length > 0) {
            let org = new organization_1.Organization(this, "Organization");
            if (email) {
                this.emailPrefix = email.split('@', 2)[0];
                this.domain = email.split('@', 2)[1];
                if (forceEmailVerification) {
                    const validateEmail = new validate_email_1.ValidateEmail(this, 'EmailValidation', { email });
                    org.node.addDependency(validateEmail);
                }
            }
            let orgTrail = new organization_trail_1.OrganizationTrail(this, 'OrganizationTrail', { OrganizationId: org.id });
            orgTrail.node.addDependency(org);
            let previousSequentialConstruct = orgTrail;
            nestedOU.forEach(nestedOU => {
                previousSequentialConstruct = this.createOrganizationTree(nestedOU, org.rootId, previousSequentialConstruct);
            });
        }
        if (props.rootHostedZoneDNSName) {
            new dns_1.RootDns(this, 'RootDNS', {
                stagesAccounts: this.stageAccounts,
                rootHostedZoneDNSName: props.rootHostedZoneDNSName,
                thirdPartyProviderDNSUsed: props.thirdPartyProviderDNSUsed ? props.thirdPartyProviderDNSUsed : true
            });
        }
        new secure_root_user_1.SecureRootUser(this, 'SecureRootUser', email);
    }
    createOrganizationTree(oUSpec, parentId, previousSequentialConstruct) {
        var _a;
        let organizationalUnit = new organizational_unit_1.OrganizationalUnit(this, `${oUSpec.name}-OU`, { Name: oUSpec.name, ParentId: parentId });
        //adding an explicit dependency as CloudFormation won't infer that Organization, Organizational Units and Accounts must be created or modified sequentially
        organizationalUnit.node.addDependency(previousSequentialConstruct);
        previousSequentialConstruct = organizationalUnit;
        oUSpec.accounts.forEach(accountSpec => {
            let accountEmail;
            if (accountSpec.email) {
                accountEmail = accountSpec.email;
            }
            else if (this.emailPrefix && this.domain) {
                accountEmail = `${this.emailPrefix}+${accountSpec.name}-${cdk.Stack.of(this).account}@${this.domain}`;
            }
            else {
                throw new Error(`Master account email must be provided or an account email for account ${accountSpec.name}`);
            }
            let account = new account_1.Account(this, accountSpec.name, {
                email: accountEmail,
                name: accountSpec.name,
                parentOrganizationalUnitId: organizationalUnit.id,
                type: accountSpec.type,
                stageName: accountSpec.stageName,
                stageOrder: accountSpec.stageOrder,
                hostedServices: accountSpec.hostedServices
            });
            // Adding an explicit dependency as CloudFormation won't infer that Organization, Organizational Units and Accounts must be created or modified sequentially
            account.node.addDependency(previousSequentialConstruct);
            previousSequentialConstruct = account;
            // Building stageAccounts array to be used for DNS delegation system
            if (['Prod', 'SDLC'].includes(oUSpec.name)) {
                this.stageAccounts.push(account);
            }
        });
        (_a = oUSpec.nestedOU) === null || _a === void 0 ? void 0 : _a.forEach(nestedOU => {
            previousSequentialConstruct = this.createOrganizationTree(nestedOU, organizationalUnit.id, previousSequentialConstruct);
        });
        return previousSequentialConstruct;
    }
}
exports.AwsOrganizationsStack = AwsOrganizationsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLW9yZ2FuaXphdGlvbnMtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhd3Mtb3JnYW5pemF0aW9ucy1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0VBY0U7OztBQUVGLHFDQUFxQztBQUNyQyxpREFBNEM7QUFDNUMsK0RBQXlEO0FBQ3pELHVDQUErQztBQUMvQyx5REFBa0Q7QUFDbEQsNkRBQXVEO0FBQ3ZELGtEQUF3QztBQUN4QywrQkFBZ0M7QUFDaEMscURBQWlEOzs7O0FBeUZqRCxNQUFhLHFCQUFzQixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBdURsRCxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQWlDO1FBQzdFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUMsV0FBVyxFQUFFLCtEQUErRCxzQkFBTyxHQUFHLEVBQUUsR0FBRyxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBcER0RyxrQkFBYSxHQUFjLEVBQUUsQ0FBQztRQXFEN0MsTUFBTSxFQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsc0JBQXNCLEdBQUcsSUFBSSxFQUFDLEdBQUcsS0FBSyxDQUFDO1FBRS9ELElBQUcsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQ3RCO1lBQ0UsSUFBSSxHQUFHLEdBQUcsSUFBSSwyQkFBWSxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQztZQUNqRCxJQUFHLEtBQUssRUFDUjtnQkFDRSxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUVyQyxJQUFHLHNCQUFzQixFQUFFO29CQUN6QixNQUFNLGFBQWEsR0FBRyxJQUFJ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SCw0SkFBNEo7WUFDNUosT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUN4RCwyQkFBMkIsR0FBRyxPQUFPLENBQUM7WUFFdEMsb0VBQW9FO1lBQ3BFLElBQUcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDekMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDbEM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQUEsTUFBTSxDQUFDLFFBQVEsMENBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ2xDLDJCQUEyQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLEVBQUUsa0JBQWtCLENBQUMsRUFBRSxFQUFFLDJCQUEyQixDQUFDLENBQUM7UUFDMUgsQ0FBQyxFQUFFO1FBRUgsT0FBTywyQkFBMkIsQ0FBQztJQUNyQyxDQUFDO0NBMENGO0FBL0ZELHNEQStGQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbllvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQge09yZ2FuaXphdGlvbn0gZnJvbSAnLi9vcmdhbml6YXRpb24nO1xuaW1wb3J0IHtPcmdhbml6YXRpb25hbFVuaXR9IGZyb20gJy4vb3JnYW5pemF0aW9uYWwtdW5pdCc7XG5pbXBvcnQge0FjY291bnQsIEFjY291bnRUeXBlfSBmcm9tICcuL2FjY291bnQnO1xuaW1wb3J0IHtTZWN1cmVSb290VXNlcn0gZnJvbSAnLi9zZWN1cmUtcm9vdC11c2VyJztcbmltcG9ydCB7T3JnYW5pemF0aW9uVHJhaWx9IGZyb20gJy4vb3JnYW5pemF0aW9uLXRyYWlsJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7IFJvb3REbnMgfSBmcm9tICcuL2Rucyc7XG5pbXBvcnQgeyBWYWxpZGF0ZUVtYWlsIH0gZnJvbSAnLi92YWxpZGF0ZS1lbWFpbCc7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGludGVyZmFjZSBBY2NvdW50U3BlYyB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZyxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgZW1haWw/OiBzdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSB0eXBlPzogQWNjb3VudFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBzdGFnZU5hbWU/OiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgc3RhZ2VPcmRlcj86IG51bWJlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgaG9zdGVkU2VydmljZXM/OiBzdHJpbmdbXTtcbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgT1VTcGVjIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBuYW1lOiBzdHJpbmcsXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBhY2NvdW50czogQWNjb3VudFNwZWNbXSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IG5lc3RlZE9VPzogT1VTcGVjW11cbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgQXdzT3JnYW5pemF0aW9uc1N0YWNrUHJvcHMgZXh0ZW5kcyBjZGsuU3RhY2tQcm9wcyB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGVtYWlsOiBzdHJpbmcsXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgbmVzdGVkT1U6IE9VU3BlY1tdLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgcm9vdEhvc3RlZFpvbmVETlNOYW1lPzogc3RyaW5nLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHRoaXJkUGFydHlQcm92aWRlckROU1VzZWQ/OiBib29sZWFuLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgZm9yY2VFbWFpbFZlcmlmaWNhdGlvbj86IGJvb2xlYW4sXG59XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgY2xhc3MgQXdzT3JnYW5pemF0aW9uc1N0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICBwcml2YXRlIHJlYWRvbmx5IGVtYWlsUHJlZml4Pzogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IGRvbWFpbj86IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFnZUFjY291bnRzOiBBY2NvdW50W10gPSBbXTsgXG5cbiAgcHJpdmF0ZSBjcmVhdGVPcmdhbml6YXRpb25UcmVlKG9VU3BlYzogT1VTcGVjLCBwYXJlbnRJZDogc3RyaW5nLCBwcmV2aW91c1NlcXVlbnRpYWxDb25zdHJ1Y3Q6IGNkay5JRGVwZW5kYWJsZSk6IGNkay5JRGVwZW5kYWJsZSB7XG5cbiAgICBsZXQgb3JnYW5pemF0aW9uYWxVbml0ID0gbmV3IE9yZ2FuaXphdGlvbmFsVW5pdCh0aGlzLCBgJHtvVVNwZWMubmFtZX0tT1VgLCB7TmFtZTogb1VTcGVjLm5hbWUsIFBhcmVudElkOiBwYXJlbnRJZH0pO1xuICAgIC8vYWRkaW5nIGFuIGV4cGxpY2l0IGRlcGVuZGVuY3kgYXMgQ2xvdWRGb3JtYXRpb24gd29uJ3QgaW5mZXIgdGhhdCBPcmdhbml6YXRpb24sIE9yZ2FuaXphdGlvbmFsIFVuaXRzIGFuZCBBY2NvdW50cyBtdXN0IGJlIGNyZWF0ZWQgb3IgbW9kaWZpZWQgc2VxdWVudGlhbGx5XG4gICAgb3JnYW5pemF0aW9uYWxVbml0Lm5vZGUuYWRkRGVwZW5kZW5jeShwcmV2aW91c1NlcXVlbnRpYWxDb25zdHJ1Y3QpO1xuXG4gICAgcHJldmlvdXNTZXF1ZW50aWFsQ29uc3RydWN0ID0gb3JnYW5pemF0aW9uYWxVbml0O1xuXG4gICAgb1VTcGVjLmFjY291bnRzLmZvckVhY2goYWNjb3VudFNwZWMgPT4ge1xuICAgICAgbGV0IGFjY291bnRFbWFpbDogc3RyaW5nO1xuICAgICAgaWYoYWNjb3VudFNwZWMuZW1haWwpXG4gICAgICB7XG4gICAgICAgIGFjY291bnRFbWFpbCA9IGFjY291bnRTcGVjLmVtYWlsO1xuICAgICAgfVxuICAgICAgZWxzZSBpZih0aGlzLmVtYWlsUHJlZml4ICYmIHRoaXMuZG9tYWluKVxuICAgICAge1xuICAgICAgICBhY2NvdW50RW1haWwgPSBgJHt0aGlzLmVtYWlsUHJlZml4fSske2FjY291bnRTcGVjLm5hbWV9LSR7Y2RrLlN0YWNrLm9mKHRoaXMpLmFjY291bnR9QCR7dGhpcy5kb21haW59YFxuICAgICAgfVxuICAgICAgZWxzZVxuICAgICAge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1hc3RlciBhY2NvdW50IGVtYWlsIG11c3QgYmUgcHJvdmlkZWQgb3IgYW4gYWNjb3VudCBlbWFpbCBmb3IgYWNjb3VudCAke2FjY291bnRTcGVjLm5hbWV9YClcbiAgICAgIH1cblxuICAgICAgbGV0IGFjY291bnQgPSBuZXcgQWNjb3VudCh0aGlzLCBhY2NvdW50U3BlYy5uYW1lLCB7XG4gICAgICAgIGVtYWlsOiBhY2NvdW50RW1haWwsXG4gICAgICAgIG5hbWU6IGFjY291bnRTcGVjLm5hbWUsXG4gICAgICAgIHBhcmVudE9yZ2FuaXphdGlvbmFsVW5pdElkOiBvcmdhbml6YXRpb25hbFVuaXQuaWQsXG4gICAgICAgIHR5cGU6IGFjY291bnRTcGVjLnR5cGUsXG4gICAgICAgIHN0YWdlTmFtZTogYWNjb3VudFNwZWMuc3RhZ2VOYW1lLFxuICAgICAgICBzdGFnZU9yZGVyOiBhY2NvdW50U3BlYy5zdGFnZU9yZGVyLFxuICAgICAgICBob3N0ZWRTZXJ2aWNlczogYWNjb3VudFNwZWMuaG9zdGVkU2VydmljZXNcbiAgICAgIH0pO1xuICAgICAgLy8gQWRkaW5nIGFuIGV4cGxpY2l0IGRlcGVuZGVuY3kgYXMgQ2xvdWRGb3JtYXRpb24gd29uJ3QgaW5mZXIgdGhhdCBPcmdhbml6YXRpb24sIE9yZ2FuaXphdGlvbmFsIFVuaXRzIGFuZCBBY2NvdW50cyBtdXN0IGJlIGNyZWF0ZWQgb3IgbW9kaWZpZWQgc2VxdWVudGlhbGx5XG4gICAgICBhY2NvdW50Lm5vZGUuYWRkRGVwZW5kZW5jeShwcmV2aW91c1NlcXVlbnRpYWxDb25zdHJ1Y3QpO1xuICAgICAgcHJldmlvdXNTZXF1ZW50aWFsQ29uc3RydWN0ID0gYWNjb3VudDtcblxuICAgICAgLy8gQnVpbGRpbmcgc3RhZ2VBY2NvdW50cyBhcnJheSB0byBiZSB1c2VkIGZvciBETlMgZGVsZWdhdGlvbiBzeXN0ZW1cbiAgICAgIGlmKFsnUHJvZCcsICdTRExDJ10uaW5jbHVkZXMob1VTcGVjLm5hbWUpKSB7XG4gICAgICAgIHRoaXMuc3RhZ2VBY2NvdW50cy5wdXNoKGFjY291bnQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgb1VTcGVjLm5lc3RlZE9VPy5mb3JFYWNoKG5lc3RlZE9VID0+IHtcbiAgICAgIHByZXZpb3VzU2VxdWVudGlhbENvbnN0cnVjdCA9IHRoaXMuY3JlYXRlT3JnYW5pemF0aW9uVHJlZShuZXN0ZWRPVSwgb3JnYW5pemF0aW9uYWxVbml0LmlkLCBwcmV2aW91c1NlcXVlbnRpYWxDb25zdHJ1Y3QpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByZXZpb3VzU2VxdWVudGlhbENvbnN0cnVjdDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXdzT3JnYW5pemF0aW9uc1N0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHtkZXNjcmlwdGlvbjogYFNvZnR3YXJlIGRldmVsb3BtZW50IExhbmRpbmcgWm9uZSAodWtzYi0xcjdhbjhvNDUpICh2ZXJzaW9uOiR7dmVyc2lvbn0pYCwgLi4ucHJvcHN9KTtcbiAgICBjb25zdCB7ZW1haWwsIG5lc3RlZE9VLCBmb3JjZUVtYWlsVmVyaWZpY2F0aW9uID0gdHJ1ZX0gPSBwcm9wcztcblxuICAgIGlmKG5lc3RlZE9VLmxlbmd0aCA+IDApXG4gICAge1xuICAgICAgbGV0IG9yZyA9IG5ldyBPcmdhbml6YXRpb24odGhpcywgXCJPcmdhbml6YXRpb25cIik7XG4gICAgICBpZihlbWFpbClcbiAgICAgIHtcbiAgICAgICAgdGhpcy5lbWFpbFByZWZpeCA9IGVtYWlsLnNwbGl0KCdAJywgMilbMF07XG4gICAgICAgIHRoaXMuZG9tYWluID0gZW1haWwuc3BsaXQoJ0AnLCAyKVsxXTtcblxuICAgICAgICBpZihmb3JjZUVtYWlsVmVyaWZpY2F0aW9uKSB7XG4gICAgICAgICAgY29uc3QgdmFsaWRhdGVFbWFpbCA9IG5ldyBWYWxpZGF0ZUVtYWlsKHRoaXMsICdFbWFpbFZhbGlkYXRpb24nLCB7IGVtYWlsIH0pO1xuICAgICAgICAgIG9yZy5ub2RlLmFkZERlcGVuZGVuY3kodmFsaWRhdGVFbWFpbCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbGV0IG9yZ1RyYWlsID0gbmV3IE9yZ2FuaXphdGlvblRyYWlsKHRoaXMsICdPcmdhbml6YXRpb25UcmFpbCcsIHtPcmdhbml6YXRpb25JZDogb3JnLmlkfSk7XG4gICAgICBvcmdUcmFpbC5ub2RlLmFkZERlcGVuZGVuY3kob3JnKTtcblxuICAgICAgbGV0IHByZXZpb3VzU2VxdWVudGlhbENvbnN0cnVjdDogY2RrLklEZXBlbmRhYmxlID0gb3JnVHJhaWw7XG5cbiAgICAgIG5lc3RlZE9VLmZvckVhY2gobmVzdGVkT1UgPT4ge1xuICAgICAgICBwcmV2aW91c1NlcXVlbnRpYWxDb25zdHJ1Y3QgPSB0aGlzLmNyZWF0ZU9yZ2FuaXphdGlvblRyZWUobmVzdGVkT1UsIG9yZy5yb290SWQsIHByZXZpb3VzU2VxdWVudGlhbENvbnN0cnVjdCk7XG4gICAgICB9KTtcblxuXG4gICAgfVxuXG4gICAgaWYocHJvcHMucm9vdEhvc3RlZFpvbmVETlNOYW1lKXtcbiAgICAgIG5ldyBSb290RG5zKHRoaXMsICdSb290RE5TJywge1xuICAgICAgICBzdGFnZXNBY2NvdW50czogdGhpcy5zdGFnZUFjY291bnRzLFxuICAgICAgICByb290SG9zdGVkWm9uZUROU05hbWU6IHByb3BzLnJvb3RIb3N0ZWRab25lRE5TTmFtZSxcbiAgICAgICAgdGhpcmRQYXJ0eVByb3ZpZGVyRE5TVXNlZDogcHJvcHMudGhpcmRQYXJ0eVByb3ZpZGVyRE5TVXNlZD9wcm9wcy50aGlyZFBhcnR5UHJvdmlkZXJETlNVc2VkOnRydWVcbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBuZXcgU2VjdXJlUm9vdFVzZXIodGhpcywgJ1NlY3VyZVJvb3RVc2VyJywgZW1haWwpO1xuICB9XG59XG4iXX0=